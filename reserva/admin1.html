<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Administração - Lar Espírita Maria Lobato de Freitas</title>
  <style>
    :root {
      --primary: #28a745;
      --secondary: #6c757d;
      --dark: #343a40;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background-color: #f4f4f4;
      color: #333;
    }

    header {
      background-color: var(--dark);
      color: white;
      text-align: center;
      padding: 1rem;
    }

    #msg {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.95rem;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      white-space: nowrap;
    }

    #msg.show {
      opacity: 1;
      pointer-events: auto;
    }

    #msg.success {
      background-color: #28a745;
    }

    #msg.error {
      background-color: #dc3545;
    }

    .card {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      margin: 1rem auto;
      max-width: 600px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    h2 {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      color: var(--dark);
    }

    input[type="text"],
    input[type="password"],
    input[type="number"] {
      width: 100%;
      padding: 0.6rem;
      margin-top: 0.2rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    th,
    td {
      border-bottom: 1px solid #ddd;
      padding: 0.5rem;
      text-align: left;
    }

    td input {
      width: 95%;
    }

    .btn {
      padding: 0.6rem 1.2rem;
      margin: 0.3rem;
      font-size: 1rem;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      color: white;
    }

    .btn-primary {
      background-color: var(--primary);
    }

    .btn-secondary {
      background-color: var(--secondary);
    }

    .center-buttons {
      text-align: center;
      margin-top: 1rem;
    }

    fieldset {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      background-color: #fafafa;
    }

    legend {
      font-weight: bold;
      padding: 0 8px;
    }

    .horario-linha {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 1rem;
    }

    .horario-campo {
      display: flex;
      flex-direction: column;
      min-width: 130px;
      margin-right: 10px;
    }

    .horario-campo label {
      margin-bottom: 5px;
      white-space: nowrap;
    }

    footer {
      background-color: #e9ebee;
      text-align: center;
      padding: 1rem;
      margin-top: 2rem;
      font-size: 0.9rem;
    }
  </style>
</head>

<body>
  <header>
    <h1>Administração - Lar Espírita Maria Lobato de Freitas</h1>
  </header>
  <div id="msg"></div>

  <div id="login-section" class="card">
    <h2>Login do Administrador</h2>
    <input id="admin-pass" type="password" placeholder="Senha" />
    <button class="btn btn-primary" onclick="realizarLogin()">Entrar</button>
  </div>

  <div id="admin-section" class="card" style="display:none;">
    <h2>Gerenciar Usuários</h2>
    <table>
      <thead>
        <tr>
          <th>Usuário</th>
          <th>Senha</th>
          <th>Remover</th>
        </tr>
      </thead>
      <tbody id="users-tbody"></tbody>
    </table>
    <div class="center-buttons"><button id="add-btn" class="btn btn-primary">Adicionar Usuário</button></div>
  </div>

  <div id="horarios-section" class="card" style="display:none;">
    <h2>Horários de Funcionamento do Alarme</h2>
    <form id="horarios-form">
      <fieldset>
        <legend>Segunda a Sexta</legend>
        <div class="horario-linha">
          <div class="horario-campo">
            <label for="arm_hour_weekday">Hora para Armar:</label>
            <input type="number" id="arm_hour_weekday" min="0" max="23">
          </div>
          <div class="horario-campo">
            <label for="disarm_hour_weekday">Hora para Desarmar:</label>
            <input type="number" id="disarm_hour_weekday" min="0" max="23">
          </div>
        </div>
      </fieldset>
      <fieldset>
        <legend>Fins de Semana</legend>
        <div class="horario-linha">
          <div class="horario-campo">
            <label for="arm_hour_weekend">Hora para Armar:</label>
            <input type="number" id="arm_hour_weekend" min="0" max="23">
          </div>
          <div class="horario-campo">
            <label for="disarm_hour_weekend">Hora para Desarmar:</label>
            <input type="number" id="disarm_hour_weekend" min="0" max="23">
          </div>
        </div>
      </fieldset>
      <fieldset>
        <legend>Configuração de Reinício Diário</legend>
        <div class="horario-linha">
          <div class="horario-campo">
            <label for="hora_restart">Hora do Reinício:</label>
            <input type="number" id="hora_restart" min="0" max="23">
          </div>
          <div class="horario-campo" style="margin-top: 30px;">
            <label><input type="checkbox" id="restart_config"> Habilitar reinício automático</label>
          </div>
        </div>
      </fieldset>
    </form>
    <div class="center-buttons">
      <button id="save-all-btn" class="btn btn-primary">Salvar</button>
      <button type="button" class="btn btn-secondary" onclick="location.reload()">Cancelar</button>
    </div>
  </div>

  <footer>
    <p><em>Nossa Missão: "Promover o ser humano em seu desenvolvimento moral e espiritual, acolhendo-o fraternalmente,
        propiciando o estudo, a divulgação e a prática da doutrina espírita."</em></p>
  </footer>

  <script>
    let adminSenhaAtual = "";
    const msgDiv = document.getElementById('msg');

    function showMessage(text, type) {
      msgDiv.textContent = text;
      msgDiv.className = 'show';
      if (type) msgDiv.classList.add(type);
      setTimeout(() => msgDiv.classList.remove('show'), 4000);
    }

    async function realizarLogin() {
      const senha = document.getElementById("admin-pass").value.trim();

      if (!senha) {
        showMessage("Digite a senha", "error");
        return;
      }

      try {
        const response = await fetch('/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `senha=${encodeURIComponent(senha)}`
        });

        if (response.ok) {
          adminSenhaAtual = senha;
          mostrarInterfaceAdmin();
          carregarUsuarios(); // Nova função para carregar usuários
          carregarHorarios();
          showMessage("Login realizado com sucesso", "success");
        } else {
          showMessage("Senha incorreta", "error");
        }
      } catch (e) {
        console.error("Erro ao realizar login:", e);
        showMessage("Erro de conexão com o servidor", "error");
      }
    }

    function mostrarInterfaceAdmin() {
      document.getElementById("login-section").style.display = "none";
      document.getElementById("admin-section").style.display = "block";
      document.getElementById("horarios-section").style.display = "block";
    }

    // Nova função para carregar usuários
    async function carregarUsuarios() {
      try {
        const response = await fetch('/usuarios.json?senha=' + encodeURIComponent(adminSenhaAtual));
        if (!response.ok) throw new Error("Falha ao carregar usuários");

        const usuarios = await response.json();
        document.getElementById("users-tbody").innerHTML = ""; // Limpa a tabela

        if (usuarios && usuarios.length > 0) {
          usuarios.forEach(user => addUserRow(user.usuario, user.senha));
        } else {
          // Adiciona uma linha vazia se não houver usuários
          addUserRow();
        }
      } catch (e) {
        console.error("Erro ao carregar usuários:", e);
        showMessage("Erro ao carregar lista de usuários", "error");
      }
    }

    function addUserRow(usuario = '', senha = '') {
      const tr = document.createElement('tr');
      const tdUser = document.createElement('td');
      const tdPass = document.createElement('td');
      const tdRemove = document.createElement('td');

      const userInput = document.createElement('input');
      userInput.type = 'text';
      userInput.value = usuario;
      userInput.placeholder = 'Usuário';

      const passInput = document.createElement('input');
      passInput.type = 'password';
      passInput.value = senha;
      passInput.placeholder = 'Senha';

      const removeBtn = document.createElement('button');
      removeBtn.textContent = 'Remover';
      removeBtn.className = 'btn btn-secondary';
      removeBtn.onclick = () => tr.remove();

      tdUser.appendChild(userInput);
      tdPass.appendChild(passInput);
      tdRemove.appendChild(removeBtn);

      tr.appendChild(tdUser);
      tr.appendChild(tdPass);
      tr.appendChild(tdRemove);
      document.getElementById("users-tbody").appendChild(tr);
    }

    async function carregarHorarios() {
      try {
        const response = await fetch('/horarios.json?senha=' + encodeURIComponent(adminSenhaAtual));
        if (!response.ok) throw new Error("Falha ao carregar horários");

        const data = await response.json();
        document.getElementById('arm_hour_weekday').value = data.ARM_HOUR_WEEKDAY ?? 18;
        document.getElementById('disarm_hour_weekday').value = data.DISARM_HOUR_WEEKDAY ?? 6;
        document.getElementById('arm_hour_weekend').value = data.ARM_HOUR_WEEKEND ?? 0;
        document.getElementById('disarm_hour_weekend').value = data.DISARM_HOUR_WEEKEND ?? 0;
        document.getElementById('hora_restart').value = data.horaRestart ?? 23;
        document.getElementById('restart_config').checked = data.restartConfig ?? false;
      } catch (e) {
        console.error("Erro ao carregar horários:", e);
        showMessage("Erro ao carregar configurações de horário", "error");
      }
    }

    // Event Listeners
    document.getElementById("add-btn").addEventListener("click", () => addUserRow());

    document.getElementById('save-all-btn').addEventListener('click', async () => {
      const rows = document.querySelectorAll('#users-tbody tr');
      const usersData = [];
      const nomes = new Set();
      let valid = true;

      // Validação dos usuários
      rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        const userVal = inputs[0].value.trim();
        const passVal = inputs[1].value.trim();

        if (!userVal || !passVal || nomes.has(userVal)) {
          valid = false;
          row.style.backgroundColor = "#ffdddd"; // Destaca linha com problema
        } else {
          row.style.backgroundColor = ""; // Remove destaque
        }

        nomes.add(userVal);
        usersData.push({ usuario: userVal, senha: passVal });
      });

      if (!valid) {
        showMessage("Verifique os dados: usuários vazios, sem senha ou duplicados", "error");
        return;
      }

      // Preparar dados de horários
      const horariosData = {
        ARM_HOUR_WEEKDAY: parseInt(document.getElementById('arm_hour_weekday').value) || 18,
        DISARM_HOUR_WEEKDAY: parseInt(document.getElementById('disarm_hour_weekday').value) || 6,
        ARM_HOUR_WEEKEND: parseInt(document.getElementById('arm_hour_weekend').value) || 0,
        DISARM_HOUR_WEEKEND: parseInt(document.getElementById('disarm_hour_weekend').value) || 0,
        horaRestart: parseInt(document.getElementById('hora_restart').value) || 23,
        restartConfig: document.getElementById('restart_config').checked
      };

      try {
        // Salvar usuários
        const saveUsers = await fetch('/usuarios.json?senha=' + encodeURIComponent(adminSenhaAtual), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(usersData)
        });

        if (!saveUsers.ok) throw new Error("Falha ao salvar usuários");

        // Salvar horários
        const saveHorarios = await fetch('/horarios.json?senha=' + encodeURIComponent(adminSenhaAtual), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(horariosData)
        });

        if (!saveHorarios.ok) throw new Error("Falha ao salvar horários");

        // Recarregar dados no sistema
        const reload = await fetch('/recarregar_dados', { method: 'POST' });

        if (!reload.ok) throw new Error("Falha ao recarregar dados");

        showMessage("Dados salvos com sucesso!", "success");
      } catch (e) {
        console.error("Erro ao salvar dados:", e);
        showMessage("Erro ao salvar dados: " + e.message, "error");
      }
    });

  </script>
</body>

</html>